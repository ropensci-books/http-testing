<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 30 Managing cassettes | HTTP testing in R</title>
<meta name="author" content="Scott Chamberlain, Maëlle Salmon">
<meta name="description" content="30.1 Why edit cassettes? By design vcr is very good at recording HTTP interactions that actually took place. Now sometimes when testing/demo-ing your package you will want to use fake HTTP...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 30 Managing cassettes | HTTP testing in R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://books.ropensci.org/http-testing/managing-cassettes.html">
<meta property="og:description" content="30.1 Why edit cassettes? By design vcr is very good at recording HTTP interactions that actually took place. Now sometimes when testing/demo-ing your package you will want to use fake HTTP...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 30 Managing cassettes | HTTP testing in R">
<meta name="twitter:description" content="30.1 Why edit cassettes? By design vcr is very good at recording HTTP interactions that actually took place. Now sometimes when testing/demo-ing your package you will want to use fake HTTP...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.13/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><div class="inline-figure"><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></div></noscript>
<!-- End Matomo Code --><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">HTTP testing in R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Preamble</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="http-in-r-101.html"><span class="header-section-number">2</span> HTTP in R 101</a></li>
<li><a class="" href="graceful.html"><span class="header-section-number">3</span> Graceful HTTP R packages</a></li>
<li><a class="" href="pkgs-testing-chapter.html"><span class="header-section-number">4</span> Packages for HTTP testing</a></li>
<li class="book-part">Whole Game(s)</li>
<li><a class="" href="introduction.html"><span class="header-section-number">5</span> Introduction</a></li>
<li><a class="" href="vcr.html"><span class="header-section-number">6</span> Use vcr (&amp; webmockr)</a></li>
<li><a class="" href="httptest.html"><span class="header-section-number">7</span> Use httptest</a></li>
<li><a class="" href="httptest2.html"><span class="header-section-number">8</span> Use httptest2</a></li>
<li><a class="" href="mocking-pkgs-comparison.html"><span class="header-section-number">9</span> vcr and httptest</a></li>
<li><a class="" href="webfakes.html"><span class="header-section-number">10</span> Use webfakes</a></li>
<li><a class="" href="pkgs-comparison.html"><span class="header-section-number">11</span> vcr (&amp; webmockr), httptest, webfakes</a></li>
<li class="book-part">Advanced Topics</li>
<li><a class="" href="real-requests-chapter.html"><span class="header-section-number">12</span> Making real requests</a></li>
<li><a class="" href="cran-preparedness.html"><span class="header-section-number">13</span> CRAN- (and Bioconductor) preparedness for your tests</a></li>
<li><a class="" href="security-chapter.html"><span class="header-section-number">14</span> Security</a></li>
<li><a class="" href="errors-chapter.html"><span class="header-section-number">15</span> Faking HTTP errors</a></li>
<li><a class="" href="contributor-friendliness.html"><span class="header-section-number">16</span> Contributor friendliness</a></li>
<li class="book-part">Conclusion</li>
<li><a class="" href="conclusion-5.html"><span class="header-section-number">17</span> Conclusion</a></li>
<li class="book-part">webmockr details</li>
<li><a class="" href="mocking.html"><span class="header-section-number">18</span> Mocking HTTP Requests</a></li>
<li><a class="" href="webmockr-stubs.html"><span class="header-section-number">19</span> stubs</a></li>
<li><a class="" href="webmockr-testing.html"><span class="header-section-number">20</span> testing</a></li>
<li><a class="" href="webmockr-utilities.html"><span class="header-section-number">21</span> utilities</a></li>
<li class="book-part">vcr details</li>
<li><a class="" href="vcr-intro.html"><span class="header-section-number">22</span> Caching HTTP requests</a></li>
<li><a class="" href="vcr-usage.html"><span class="header-section-number">23</span> Advanced vcr usage</a></li>
<li><a class="" href="vcr-configuration.html"><span class="header-section-number">24</span> Configure vcr</a></li>
<li><a class="" href="record-modes.html"><span class="header-section-number">25</span> Record modes</a></li>
<li><a class="" href="request-matching.html"><span class="header-section-number">26</span> Request matching</a></li>
<li><a class="" href="debugging-your-tests-that-use-vcr.html"><span class="header-section-number">27</span> Debugging your tests that use vcr</a></li>
<li><a class="" href="vcr-security.html"><span class="header-section-number">28</span> Security with vcr</a></li>
<li><a class="" href="lightswitch.html"><span class="header-section-number">29</span> Turning vcr on and off</a></li>
<li><a class="active" href="managing-cassettes.html"><span class="header-section-number">30</span> Managing cassettes</a></li>
<li><a class="" href="gotchas.html"><span class="header-section-number">31</span> Gotchas</a></li>
<li><a class="" href="session-info.html"><span class="header-section-number">32</span> Session info</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/ropensci-books/http-testing">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="managing-cassettes" class="section level1" number="30">
<h1>
<span class="header-section-number">30</span> Managing cassettes<a class="anchor" aria-label="anchor" href="#managing-cassettes"><i class="fas fa-link"></i></a>
</h1>
<div id="why-edit-cassettes" class="section level2" number="30.1">
<h2>
<span class="header-section-number">30.1</span> Why edit cassettes?<a class="anchor" aria-label="anchor" href="#why-edit-cassettes"><i class="fas fa-link"></i></a>
</h2>
<p>By design vcr is very good at recording HTTP interactions that actually took place.
Now sometimes when testing/demo-ing your package you will want to use <em>fake</em> HTTP interactions.
For instance:</p>
<ul>
<li>What happens if the web API returns a 503 code? Is there an informative error?</li>
<li>What happens if it returns a 503 and then a 200 code? Does the retry work?</li>
<li>What if the API returns too much data for even simple queries and you want to make your cassettes smaller?</li>
</ul>
<p>In all these cases, you can edit your cassettes as long as you are aware of the risks!</p>
</div>
<div id="risks-related-to-cassette-editing" class="section level2" number="30.2">
<h2>
<span class="header-section-number">30.2</span> Risks related to cassette editing<a class="anchor" aria-label="anchor" href="#risks-related-to-cassette-editing"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>If you use a vcr cassette where you replace a 200 code with a 503 code, and vcr is turned off,
the test will fail because the API will probably not return an error. Use <code><a href="https://docs.ropensci.org/vcr/reference/skip_if_vcr_off.html">vcr::skip_if_vcr_off()</a></code>.</li>
<li>If you edit cassettes by hand you can’t re-record them easily, you’d need to re-record them then re-apply your edits.</li>
</ul>
<p>Therefore you’ll need to develop a good workflow.</p>
</div>
<div id="example-1-test-using-an-edited-cassette-with-a-503" class="section level2" number="30.3">
<h2>
<span class="header-section-number">30.3</span> Example 1: test using an edited cassette with a 503<a class="anchor" aria-label="anchor" href="#example-1-test-using-an-edited-cassette-with-a-503"><i class="fas fa-link"></i></a>
</h2>
<p>First, write your test e.g.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="managing-cassettes.html#cb163-1" aria-hidden="true" tabindex="-1"></a>vcr<span class="sc">::</span><span class="fu">use_cassette</span>(<span class="st">"api-error"</span>, {</span>
<span id="cb163-2"><a href="managing-cassettes.html#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">testhat</span>(<span class="st">"Errors are handled well"</span>, {</span>
<span id="cb163-3"><a href="managing-cassettes.html#cb163-3" aria-hidden="true" tabindex="-1"></a>    vcr<span class="sc">::</span><span class="fu">skip_if_vcr_off</span>()</span>
<span id="cb163-4"><a href="managing-cassettes.html#cb163-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect_error</span>(<span class="fu">call_my_api</span>()), <span class="st">"error message"</span><span class="er">)</span></span>
<span id="cb163-5"><a href="managing-cassettes.html#cb163-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb163-6"><a href="managing-cassettes.html#cb163-6" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Then run your tests a first time.</p>
<ol style="list-style-type: decimal">
<li>It will fail</li>
<li>It will have created a cassette under <code>tests/fixtures/api-error.yml</code> that looks
something like</li>
</ol>
<div class="sourceCode" id="cb164"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb164-1"><a href="managing-cassettes.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">http_interactions</span><span class="kw">:</span></span>
<span id="cb164-2"><a href="managing-cassettes.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span></span>
<span id="cb164-3"><a href="managing-cassettes.html#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">method</span><span class="kw">:</span><span class="at"> get</span></span>
<span id="cb164-4"><a href="managing-cassettes.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">uri</span><span class="kw">:</span><span class="at"> https://eu.httpbin.org/get</span></span>
<span id="cb164-5"><a href="managing-cassettes.html#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb164-6"><a href="managing-cassettes.html#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb164-7"><a href="managing-cassettes.html#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb164-8"><a href="managing-cassettes.html#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb164-9"><a href="managing-cassettes.html#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">User-Agent</span><span class="kw">:</span><span class="at"> libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span></span>
<span id="cb164-10"><a href="managing-cassettes.html#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">response</span><span class="kw">:</span></span>
<span id="cb164-11"><a href="managing-cassettes.html#cb164-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb164-12"><a href="managing-cassettes.html#cb164-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status_code</span><span class="kw">:</span><span class="at"> </span><span class="st">'200'</span></span>
<span id="cb164-13"><a href="managing-cassettes.html#cb164-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">message</span><span class="kw">:</span><span class="at"> OK</span></span>
<span id="cb164-14"><a href="managing-cassettes.html#cb164-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">explanation</span><span class="kw">:</span><span class="at"> Request fulfilled, document follows</span></span>
<span id="cb164-15"><a href="managing-cassettes.html#cb164-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb164-16"><a href="managing-cassettes.html#cb164-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status</span><span class="kw">:</span><span class="at"> HTTP/1.1 200 OK</span></span>
<span id="cb164-17"><a href="managing-cassettes.html#cb164-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">connection</span><span class="kw">:</span><span class="at"> keep-alive</span></span>
<span id="cb164-18"><a href="managing-cassettes.html#cb164-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb164-19"><a href="managing-cassettes.html#cb164-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> UTF-8</span></span>
<span id="cb164-20"><a href="managing-cassettes.html#cb164-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">"{</span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">args</span><span class="sc">\"</span><span class="st">: {}, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">headers</span><span class="sc">\"</span><span class="st">: {</span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">application/json,</span></span>
<span id="cb164-21"><a href="managing-cassettes.html#cb164-21" aria-hidden="true" tabindex="-1"></a><span class="st">        text/xml, application/xml, */*</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept-Encoding</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">gzip, deflate</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb164-22"><a href="managing-cassettes.html#cb164-22" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Connection</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">close</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Host</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">httpbin.org</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">User-Agent</span><span class="sc">\"</span><span class="st">:</span></span>
<span id="cb164-23"><a href="managing-cassettes.html#cb164-23" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\"</span><span class="st">libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span><span class="sc">\"\n</span><span class="st">  }, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">origin</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">111.222.333.444</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb164-24"><a href="managing-cassettes.html#cb164-24" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">url</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">https://eu.httpbin.org/get</span><span class="sc">\"\n</span><span class="st">}</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb164-25"><a href="managing-cassettes.html#cb164-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">recorded_at</span><span class="kw">:</span><span class="at"> 2018-04-03 22:55:02 GMT</span></span>
<span id="cb164-26"><a href="managing-cassettes.html#cb164-26" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">recorded_with</span><span class="kw">:</span><span class="at"> vcr/0.1.0, webmockr/0.2.4, crul/0.5.2</span></span></code></pre></div>
<p>You can edit to (new status code)</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb165-1"><a href="managing-cassettes.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">http_interactions</span><span class="kw">:</span></span>
<span id="cb165-2"><a href="managing-cassettes.html#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span></span>
<span id="cb165-3"><a href="managing-cassettes.html#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">method</span><span class="kw">:</span><span class="at"> get</span></span>
<span id="cb165-4"><a href="managing-cassettes.html#cb165-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">uri</span><span class="kw">:</span><span class="at"> https://eu.httpbin.org/get</span></span>
<span id="cb165-5"><a href="managing-cassettes.html#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb165-6"><a href="managing-cassettes.html#cb165-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb165-7"><a href="managing-cassettes.html#cb165-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb165-8"><a href="managing-cassettes.html#cb165-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb165-9"><a href="managing-cassettes.html#cb165-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">User-Agent</span><span class="kw">:</span><span class="at"> libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span></span>
<span id="cb165-10"><a href="managing-cassettes.html#cb165-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">response</span><span class="kw">:</span></span>
<span id="cb165-11"><a href="managing-cassettes.html#cb165-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb165-12"><a href="managing-cassettes.html#cb165-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status_code</span><span class="kw">:</span><span class="at"> </span><span class="st">'503'</span></span></code></pre></div>
<p>And run your test again, it should pass!
Note the use of <code><a href="https://docs.ropensci.org/vcr/reference/skip_if_vcr_off.html">vcr::skip_if_vcr_off()</a></code>: if vcr is turned off, there is a real
API request and most probably this request won’t get a 503 as a status code.</p>
<div id="the-same-thing-with-webmockr" class="section level3" number="30.3.1">
<h3>
<span class="header-section-number">30.3.1</span> The same thing with webmockr<a class="anchor" aria-label="anchor" href="#the-same-thing-with-webmockr"><i class="fas fa-link"></i></a>
</h3>
<p>The advantage of the approach involving editing cassettes is that you only learn
one thing, which is vcr.
Now, by using the webmockr directly in your tests, you can also test for the
behavior of your package in case of errors.
Below we assume <code>api_url()</code> returns the URL <code>call_my_api()</code> calls.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="managing-cassettes.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testhat</span>(<span class="st">"Errors are handled well"</span>, {</span>
<span id="cb166-2"><a href="managing-cassettes.html#cb166-2" aria-hidden="true" tabindex="-1"></a>  webmockr<span class="sc">::</span><span class="fu">enable</span>()</span>
<span id="cb166-3"><a href="managing-cassettes.html#cb166-3" aria-hidden="true" tabindex="-1"></a>  stub <span class="ot">&lt;-</span> webmockr<span class="sc">::</span><span class="fu">stub_request</span>(<span class="st">"get"</span>, <span class="fu">api_url</span>())</span>
<span id="cb166-4"><a href="managing-cassettes.html#cb166-4" aria-hidden="true" tabindex="-1"></a>  webmockr<span class="sc">::</span><span class="fu">to_return</span>(stub, <span class="at">status =</span> <span class="dv">503</span>)</span>
<span id="cb166-5"><a href="managing-cassettes.html#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_error</span>(<span class="fu">call_my_api</span>()), <span class="st">"error message"</span><span class="er">)</span></span>
<span id="cb166-6"><a href="managing-cassettes.html#cb166-6" aria-hidden="true" tabindex="-1"></a>  webmockr<span class="sc">::</span><span class="fu">disable</span>()</span>
<span id="cb166-7"><a href="managing-cassettes.html#cb166-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-8"><a href="managing-cassettes.html#cb166-8" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>A big pro of this approach is that it works even when vcr is turned off.
A con is that it’s quite different from the vcr syntax.</p>
</div>
</div>
<div id="example-2-test-using-an-edited-cassette-with-a-503-then-a-200" class="section level2" number="30.4">
<h2>
<span class="header-section-number">30.4</span> Example 2: test using an edited cassette with a 503 then a 200<a class="anchor" aria-label="anchor" href="#example-2-test-using-an-edited-cassette-with-a-503-then-a-200"><i class="fas fa-link"></i></a>
</h2>
<p>Here we assume your package contains some sort of <a href="https://blog.r-hub.io/2020/04/07/retry-wheel/">retry</a>.</p>
<p>First, write your test e.g.</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="managing-cassettes.html#cb167-1" aria-hidden="true" tabindex="-1"></a>vcr<span class="sc">::</span><span class="fu">use_cassette</span>(<span class="st">"api-error"</span>, {</span>
<span id="cb167-2"><a href="managing-cassettes.html#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">testhat</span>(<span class="st">"Errors are handled well"</span>, {</span>
<span id="cb167-3"><a href="managing-cassettes.html#cb167-3" aria-hidden="true" tabindex="-1"></a>    vcr<span class="sc">::</span><span class="fu">skip_if_vcr_off</span>()</span>
<span id="cb167-4"><a href="managing-cassettes.html#cb167-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect_message</span>(thing <span class="ot">&lt;-</span> <span class="fu">call_my_api</span>()), <span class="st">"retry message"</span><span class="er">)</span></span>
<span id="cb167-5"><a href="managing-cassettes.html#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect_s4_class</span>(thing, <span class="st">"data.frame"</span>)</span>
<span id="cb167-6"><a href="managing-cassettes.html#cb167-6" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb167-7"><a href="managing-cassettes.html#cb167-7" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Then run your tests a first time.</p>
<ol style="list-style-type: decimal">
<li>It will fail</li>
<li>It will have created a cassette under <code>tests/fixtures/api-error.yml</code> that looks
something like</li>
</ol>
<div class="sourceCode" id="cb168"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb168-1"><a href="managing-cassettes.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">http_interactions</span><span class="kw">:</span></span>
<span id="cb168-2"><a href="managing-cassettes.html#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span></span>
<span id="cb168-3"><a href="managing-cassettes.html#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">method</span><span class="kw">:</span><span class="at"> get</span></span>
<span id="cb168-4"><a href="managing-cassettes.html#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">uri</span><span class="kw">:</span><span class="at"> https://eu.httpbin.org/get</span></span>
<span id="cb168-5"><a href="managing-cassettes.html#cb168-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb168-6"><a href="managing-cassettes.html#cb168-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb168-7"><a href="managing-cassettes.html#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb168-8"><a href="managing-cassettes.html#cb168-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb168-9"><a href="managing-cassettes.html#cb168-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">User-Agent</span><span class="kw">:</span><span class="at"> libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span></span>
<span id="cb168-10"><a href="managing-cassettes.html#cb168-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">response</span><span class="kw">:</span></span>
<span id="cb168-11"><a href="managing-cassettes.html#cb168-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb168-12"><a href="managing-cassettes.html#cb168-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status_code</span><span class="kw">:</span><span class="at"> </span><span class="st">'200'</span></span>
<span id="cb168-13"><a href="managing-cassettes.html#cb168-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">message</span><span class="kw">:</span><span class="at"> OK</span></span>
<span id="cb168-14"><a href="managing-cassettes.html#cb168-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">explanation</span><span class="kw">:</span><span class="at"> Request fulfilled, document follows</span></span>
<span id="cb168-15"><a href="managing-cassettes.html#cb168-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb168-16"><a href="managing-cassettes.html#cb168-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status</span><span class="kw">:</span><span class="at"> HTTP/1.1 200 OK</span></span>
<span id="cb168-17"><a href="managing-cassettes.html#cb168-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">connection</span><span class="kw">:</span><span class="at"> keep-alive</span></span>
<span id="cb168-18"><a href="managing-cassettes.html#cb168-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb168-19"><a href="managing-cassettes.html#cb168-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> UTF-8</span></span>
<span id="cb168-20"><a href="managing-cassettes.html#cb168-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">"{</span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">args</span><span class="sc">\"</span><span class="st">: {}, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">headers</span><span class="sc">\"</span><span class="st">: {</span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">application/json,</span></span>
<span id="cb168-21"><a href="managing-cassettes.html#cb168-21" aria-hidden="true" tabindex="-1"></a><span class="st">        text/xml, application/xml, */*</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept-Encoding</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">gzip, deflate</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb168-22"><a href="managing-cassettes.html#cb168-22" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Connection</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">close</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Host</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">httpbin.org</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">User-Agent</span><span class="sc">\"</span><span class="st">:</span></span>
<span id="cb168-23"><a href="managing-cassettes.html#cb168-23" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\"</span><span class="st">libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span><span class="sc">\"\n</span><span class="st">  }, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">origin</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">111.222.333.444</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb168-24"><a href="managing-cassettes.html#cb168-24" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">url</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">https://eu.httpbin.org/get</span><span class="sc">\"\n</span><span class="st">}</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb168-25"><a href="managing-cassettes.html#cb168-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">recorded_at</span><span class="kw">:</span><span class="at"> 2018-04-03 22:55:02 GMT</span></span>
<span id="cb168-26"><a href="managing-cassettes.html#cb168-26" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">recorded_with</span><span class="kw">:</span><span class="at"> vcr/0.1.0, webmockr/0.2.4, crul/0.5.2</span></span></code></pre></div>
<p>You can duplicate the HTTP interaction, and make the first one return a 503 status code.
vcr will first use the first interaction, then the second one, when making the same request.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb169-1"><a href="managing-cassettes.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">http_interactions</span><span class="kw">:</span></span>
<span id="cb169-2"><a href="managing-cassettes.html#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span></span>
<span id="cb169-3"><a href="managing-cassettes.html#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">method</span><span class="kw">:</span><span class="at"> get</span></span>
<span id="cb169-4"><a href="managing-cassettes.html#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">uri</span><span class="kw">:</span><span class="at"> https://eu.httpbin.org/get</span></span>
<span id="cb169-5"><a href="managing-cassettes.html#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb169-6"><a href="managing-cassettes.html#cb169-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb169-7"><a href="managing-cassettes.html#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb169-8"><a href="managing-cassettes.html#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb169-9"><a href="managing-cassettes.html#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">User-Agent</span><span class="kw">:</span><span class="at"> libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span></span>
<span id="cb169-10"><a href="managing-cassettes.html#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">response</span><span class="kw">:</span></span>
<span id="cb169-11"><a href="managing-cassettes.html#cb169-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb169-12"><a href="managing-cassettes.html#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status_code</span><span class="kw">:</span><span class="at"> </span><span class="st">'503'</span></span>
<span id="cb169-13"><a href="managing-cassettes.html#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span></span>
<span id="cb169-14"><a href="managing-cassettes.html#cb169-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">method</span><span class="kw">:</span><span class="at"> get</span></span>
<span id="cb169-15"><a href="managing-cassettes.html#cb169-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">uri</span><span class="kw">:</span><span class="at"> https://eu.httpbin.org/get</span></span>
<span id="cb169-16"><a href="managing-cassettes.html#cb169-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb169-17"><a href="managing-cassettes.html#cb169-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb169-18"><a href="managing-cassettes.html#cb169-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">''</span></span>
<span id="cb169-19"><a href="managing-cassettes.html#cb169-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb169-20"><a href="managing-cassettes.html#cb169-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">User-Agent</span><span class="kw">:</span><span class="at"> libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span></span>
<span id="cb169-21"><a href="managing-cassettes.html#cb169-21" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">response</span><span class="kw">:</span></span>
<span id="cb169-22"><a href="managing-cassettes.html#cb169-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb169-23"><a href="managing-cassettes.html#cb169-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status_code</span><span class="kw">:</span><span class="at"> </span><span class="st">'200'</span></span>
<span id="cb169-24"><a href="managing-cassettes.html#cb169-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">message</span><span class="kw">:</span><span class="at"> OK</span></span>
<span id="cb169-25"><a href="managing-cassettes.html#cb169-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">explanation</span><span class="kw">:</span><span class="at"> Request fulfilled, document follows</span></span>
<span id="cb169-26"><a href="managing-cassettes.html#cb169-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb169-27"><a href="managing-cassettes.html#cb169-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status</span><span class="kw">:</span><span class="at"> HTTP/1.1 200 OK</span></span>
<span id="cb169-28"><a href="managing-cassettes.html#cb169-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">connection</span><span class="kw">:</span><span class="at"> keep-alive</span></span>
<span id="cb169-29"><a href="managing-cassettes.html#cb169-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb169-30"><a href="managing-cassettes.html#cb169-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> UTF-8</span></span>
<span id="cb169-31"><a href="managing-cassettes.html#cb169-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> </span><span class="st">"{</span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">args</span><span class="sc">\"</span><span class="st">: {}, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">headers</span><span class="sc">\"</span><span class="st">: {</span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">application/json,</span></span>
<span id="cb169-32"><a href="managing-cassettes.html#cb169-32" aria-hidden="true" tabindex="-1"></a><span class="st">        text/xml, application/xml, */*</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept-Encoding</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">gzip, deflate</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb169-33"><a href="managing-cassettes.html#cb169-33" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Connection</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">close</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Host</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">httpbin.org</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">User-Agent</span><span class="sc">\"</span><span class="st">:</span></span>
<span id="cb169-34"><a href="managing-cassettes.html#cb169-34" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\"</span><span class="st">libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span><span class="sc">\"\n</span><span class="st">  }, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">origin</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">111.222.333.444</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb169-35"><a href="managing-cassettes.html#cb169-35" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">url</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">https://eu.httpbin.org/get</span><span class="sc">\"\n</span><span class="st">}</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb169-36"><a href="managing-cassettes.html#cb169-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">recorded_at</span><span class="kw">:</span><span class="at"> 2018-04-03 22:55:02 GMT</span></span>
<span id="cb169-37"><a href="managing-cassettes.html#cb169-37" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">recorded_with</span><span class="kw">:</span><span class="at"> vcr/0.1.0, webmockr/0.2.4, crul/0.5.2</span></span></code></pre></div>
<p>And run your test again, it should pass!
Note the use of <code><a href="https://docs.ropensci.org/vcr/reference/skip_if_vcr_off.html">vcr::skip_if_vcr_off()</a></code>: if vcr is turned off, there is a real
API request and most probably this request won’t get a 503 as a status code.</p>
<div id="the-same-thing-with-webmockr-1" class="section level3" number="30.4.1">
<h3>
<span class="header-section-number">30.4.1</span> The same thing with webmockr<a class="anchor" aria-label="anchor" href="#the-same-thing-with-webmockr-1"><i class="fas fa-link"></i></a>
</h3>
<p>The advantage of the approach involving editing cassettes is that you only learn
one thing, which is vcr.
Now, by using the webmockr directly in your tests, you can also test for the
behavior of your package in case of errors.
Below we assume <code>api_url()</code> returns the URL <code>call_my_api()</code> calls.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="managing-cassettes.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">testhat</span>(<span class="st">"Errors are handled well"</span>, {</span>
<span id="cb170-2"><a href="managing-cassettes.html#cb170-2" aria-hidden="true" tabindex="-1"></a>  webmockr<span class="sc">::</span><span class="fu">enable</span>()</span>
<span id="cb170-3"><a href="managing-cassettes.html#cb170-3" aria-hidden="true" tabindex="-1"></a>  stub <span class="ot">&lt;-</span> webmockr<span class="sc">::</span><span class="fu">stub_request</span>(<span class="st">"get"</span>, <span class="fu">api_url</span>())</span>
<span id="cb170-4"><a href="managing-cassettes.html#cb170-4" aria-hidden="true" tabindex="-1"></a>  stub <span class="sc">%&gt;%</span></span>
<span id="cb170-5"><a href="managing-cassettes.html#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_return</span>(<span class="at">status =</span> <span class="dv">503</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb170-6"><a href="managing-cassettes.html#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">to_return</span>(<span class="at">status =</span> <span class="dv">200</span>, <span class="at">body =</span> <span class="st">"{</span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">args</span><span class="sc">\"</span><span class="st">: {}, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">headers</span><span class="sc">\"</span><span class="st">: {</span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">application/json,</span></span>
<span id="cb170-7"><a href="managing-cassettes.html#cb170-7" aria-hidden="true" tabindex="-1"></a><span class="st">        text/xml, application/xml, */*</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Accept-Encoding</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">gzip, deflate</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb170-8"><a href="managing-cassettes.html#cb170-8" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Connection</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">close</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">Host</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">httpbin.org</span><span class="sc">\"</span><span class="st">, </span><span class="sc">\n</span><span class="st">    </span><span class="sc">\"</span><span class="st">User-Agent</span><span class="sc">\"</span><span class="st">:</span></span>
<span id="cb170-9"><a href="managing-cassettes.html#cb170-9" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\"</span><span class="st">libcurl/7.54.0 r-curl/3.2 crul/0.5.2</span><span class="sc">\"\n</span><span class="st">  }, </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">origin</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">111.222.333.444</span><span class="sc">\"</span><span class="st">,</span></span>
<span id="cb170-10"><a href="managing-cassettes.html#cb170-10" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">  </span><span class="sc">\"</span><span class="st">url</span><span class="sc">\"</span><span class="st">: </span><span class="sc">\"</span><span class="st">https://eu.httpbin.org/get</span><span class="sc">\"\n</span><span class="st">}</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">headers =</span> <span class="fu">list</span>(<span class="at">b =</span> <span class="dv">6</span>))</span>
<span id="cb170-11"><a href="managing-cassettes.html#cb170-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_message</span>(thing <span class="ot">&lt;-</span> <span class="fu">call_my_api</span>()), <span class="st">"retry message"</span><span class="er">)</span></span>
<span id="cb170-12"><a href="managing-cassettes.html#cb170-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect_s4_class</span>(thing, <span class="st">"data.frame"</span>)</span>
<span id="cb170-13"><a href="managing-cassettes.html#cb170-13" aria-hidden="true" tabindex="-1"></a>  webmockr<span class="sc">::</span><span class="fu">disable</span>()</span>
<span id="cb170-14"><a href="managing-cassettes.html#cb170-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-15"><a href="managing-cassettes.html#cb170-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>The pro of this approach is the elegance of the stubbing, with the two different responses.
Each webmockr function like <code><a href="https://docs.ropensci.org/webmockr/reference/to_return.html">to_return()</a></code> even has an argument <code>times</code> indicating the
number of times the given response should be returned.</p>
<p>The con is that on top of being different from vcr, in this case where we also needed
a good response in the end (the one with a 200 code, and an actual body), writing the
mock is much more cumbersome than just recording a vcr cassette.</p>
<p>Be aware when you add your cassettes to either <code>.gitignore</code> and/or
<code>.Rbuildignore</code>.</p>
</div>
</div>
<div id="gitignore-cassettes" class="section level2" number="30.5">
<h2>
<span class="header-section-number">30.5</span> gitignore cassettes<a class="anchor" aria-label="anchor" href="#gitignore-cassettes"><i class="fas fa-link"></i></a>
</h2>
<p>The <a href="https://guide.freecodecamp.org/git/gitignore/">.gitignore</a> file lets you tell [git][] what files to
ignore - those files are not tracked by git and if you share the git
repository to the public web, those files in the <code>.gitignore</code> file
won’t be shared in the public version.</p>
<p>When using <code>vcr</code> you may want to include your cassettes in the
<code>.gitignore</code> file. You may wan to when your cassettes contain sensitive
data that you don’t want to have on the internet &amp; dont want to hide
with <a href="vcr-security.html#api-keys-security">filter_sensitive_data</a>.</p>
<p>You may want to have your cassettes included in your GitHub repo, both
to be present when tests run on CI, and when others run your tests.</p>
<p>There’s no correct answer on whether to gitignore your cassettes.
Think about security implications and whether you want CI and human
contributors to use previously created cassettes or to create/use their
own.</p>
</div>
<div id="rbuildignore-cassettes" class="section level2" number="30.6">
<h2>
<span class="header-section-number">30.6</span> Rbuildignore cassettes<a class="anchor" aria-label="anchor" href="#rbuildignore-cassettes"><i class="fas fa-link"></i></a>
</h2>
<p>The <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#index-_002eRbuildignore-file">.Rbuildignore</a> file is used to tell R to ignore
certain files/directories.</p>
<p>There’s not a clear use case for why you’d want to add vcr cassettes
to your <code>.Rbuildignore</code> file, but if you do be aware that will affect
your vcr enabled tests.</p>
</div>
<div id="sharing-cassettes" class="section level2" number="30.7">
<h2>
<span class="header-section-number">30.7</span> sharing cassettes<a class="anchor" aria-label="anchor" href="#sharing-cassettes"><i class="fas fa-link"></i></a>
</h2>
<p>Sometimes you may want to share or re-use cassettes across tests,
for example to <a href="cran-preparedness.html#cran-preparedness">reduce the size for package sources</a> or
to test different functionality of your package functions
that make the same query under the hood.</p>
<p>To do so, you can use the same cassette name for multiple <code><a href="https://docs.ropensci.org/vcr/reference/use_cassette.html">vcr::use_cassette()</a></code>
calls.
<code><a href="https://docs.ropensci.org/vcr/reference/check_cassette_names.html">vcr::check_cassette_names()</a></code> will complain about duplicate cassette
names, preventing you from accidentally re-using cassettes, however.
To allow duplicates, you can provide a character vector of the cassette names
you want to re-use to the <code>allowed_duplicates</code> argument of
<code><a href="https://docs.ropensci.org/vcr/reference/check_cassette_names.html">vcr::check_cassette_names()</a></code>.
That way you can use the same cassette across multiple tests.</p>
</div>
<div id="deleting-cassettes" class="section level2" number="30.8">
<h2>
<span class="header-section-number">30.8</span> deleting cassettes<a class="anchor" aria-label="anchor" href="#deleting-cassettes"><i class="fas fa-link"></i></a>
</h2>
<p>Removing a cassette is as easy as deleting in your file finder,
or from the command line, or from within a text editor or RStudio.</p>
<p>If you delete a cassette, on the next test run the cassette will
be recorded again.</p>
<p>If you do want to re-record a test to a cassette, instead of
deleting the file you can toggle <a href="record-modes.html#record-modes">record modes</a>.</p>
</div>
<div id="cassette-file-types" class="section level2" number="30.9">
<h2>
<span class="header-section-number">30.9</span> cassette file types<a class="anchor" aria-label="anchor" href="#cassette-file-types"><i class="fas fa-link"></i></a>
</h2>
<p>For right now the only persistence option is yaml. So all files
have a <code>.yml</code> extension.</p>
<p>When other persister options are added, additional file types
may be found. The next persister type is likely to be JSON,
so if you use that option, you’d have <code>.json</code> files instead of
<code>.yml</code> files.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="lightswitch.html"><span class="header-section-number">29</span> Turning vcr on and off</a></div>
<div class="next"><a href="gotchas.html"><span class="header-section-number">31</span> Gotchas</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#managing-cassettes"><span class="header-section-number">30</span> Managing cassettes</a></li>
<li><a class="nav-link" href="#why-edit-cassettes"><span class="header-section-number">30.1</span> Why edit cassettes?</a></li>
<li><a class="nav-link" href="#risks-related-to-cassette-editing"><span class="header-section-number">30.2</span> Risks related to cassette editing</a></li>
<li>
<a class="nav-link" href="#example-1-test-using-an-edited-cassette-with-a-503"><span class="header-section-number">30.3</span> Example 1: test using an edited cassette with a 503</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#the-same-thing-with-webmockr"><span class="header-section-number">30.3.1</span> The same thing with webmockr</a></li></ul>
</li>
<li>
<a class="nav-link" href="#example-2-test-using-an-edited-cassette-with-a-503-then-a-200"><span class="header-section-number">30.4</span> Example 2: test using an edited cassette with a 503 then a 200</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#the-same-thing-with-webmockr-1"><span class="header-section-number">30.4.1</span> The same thing with webmockr</a></li></ul>
</li>
<li><a class="nav-link" href="#gitignore-cassettes"><span class="header-section-number">30.5</span> gitignore cassettes</a></li>
<li><a class="nav-link" href="#rbuildignore-cassettes"><span class="header-section-number">30.6</span> Rbuildignore cassettes</a></li>
<li><a class="nav-link" href="#sharing-cassettes"><span class="header-section-number">30.7</span> sharing cassettes</a></li>
<li><a class="nav-link" href="#deleting-cassettes"><span class="header-section-number">30.8</span> deleting cassettes</a></li>
<li><a class="nav-link" href="#cassette-file-types"><span class="header-section-number">30.9</span> cassette file types</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/ropensci-books/http-testing/blob/main/15-cassettes.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/ropensci-books/http-testing/edit/main/15-cassettes.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>HTTP testing in R</strong>" was written by Scott Chamberlain, Maëlle Salmon. It was last built on 2022-03-14.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
