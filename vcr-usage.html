<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 23 Advanced vcr usage | HTTP testing in R</title>
<meta name="author" content="Scott Chamberlain, Maëlle Salmon">
<meta name="description" content='Now that we’ve covered basic vcr usage, it’s time for some more advanced usage topics. library("vcr")  23.1 Mocking writing to disk If you have http requests for which you write the response to...'>
<meta name="generator" content="bookdown 0.37 with bs4_book()">
<meta property="og:title" content="Chapter 23 Advanced vcr usage | HTTP testing in R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://books.ropensci.org/http-testing/vcr-usage.html">
<meta property="og:description" content='Now that we’ve covered basic vcr usage, it’s time for some more advanced usage topics. library("vcr")  23.1 Mocking writing to disk If you have http requests for which you write the response to...'>
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 23 Advanced vcr usage | HTTP testing in R">
<meta name="twitter:description" content='Now that we’ve covered basic vcr usage, it’s time for some more advanced usage topics. library("vcr")  23.1 Mocking writing to disk If you have http requests for which you write the response to...'>
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><div class="inline-figure"><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></div></noscript>
<!-- End Matomo Code --><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">HTTP testing in R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Preamble</a></li>
<li class="book-part">Introduction</li>
<li><a class="" href="http-in-r-101.html"><span class="header-section-number">2</span> HTTP in R 101</a></li>
<li><a class="" href="graceful.html"><span class="header-section-number">3</span> Graceful HTTP R packages</a></li>
<li><a class="" href="pkgs-testing-chapter.html"><span class="header-section-number">4</span> Packages for HTTP testing</a></li>
<li class="book-part">Whole Game(s)</li>
<li><a class="" href="introduction.html"><span class="header-section-number">5</span> Introduction</a></li>
<li><a class="" href="vcr.html"><span class="header-section-number">6</span> Use vcr (&amp; webmockr)</a></li>
<li><a class="" href="httptest.html"><span class="header-section-number">7</span> Use httptest</a></li>
<li><a class="" href="mocking-pkgs-comparison.html"><span class="header-section-number">8</span> vcr and httptest</a></li>
<li><a class="" href="httptest2.html"><span class="header-section-number">9</span> Use httptest2</a></li>
<li><a class="" href="webfakes.html"><span class="header-section-number">10</span> Use webfakes</a></li>
<li><a class="" href="pkgs-comparison.html"><span class="header-section-number">11</span> vcr (&amp; webmockr), httptest, webfakes</a></li>
<li class="book-part">Advanced Topics</li>
<li><a class="" href="real-requests-chapter.html"><span class="header-section-number">12</span> Making real requests</a></li>
<li><a class="" href="cran-preparedness.html"><span class="header-section-number">13</span> CRAN- (and Bioconductor) preparedness for your tests</a></li>
<li><a class="" href="security-chapter.html"><span class="header-section-number">14</span> Security</a></li>
<li><a class="" href="errors-chapter.html"><span class="header-section-number">15</span> Faking HTTP errors</a></li>
<li><a class="" href="contributor-friendliness.html"><span class="header-section-number">16</span> Contributor friendliness</a></li>
<li class="book-part">Conclusion</li>
<li><a class="" href="conclusion-5.html"><span class="header-section-number">17</span> Conclusion</a></li>
<li class="book-part">webmockr details</li>
<li><a class="" href="mocking.html"><span class="header-section-number">18</span> Mocking HTTP Requests</a></li>
<li><a class="" href="webmockr-stubs.html"><span class="header-section-number">19</span> stubs</a></li>
<li><a class="" href="webmockr-testing.html"><span class="header-section-number">20</span> testing</a></li>
<li><a class="" href="webmockr-utilities.html"><span class="header-section-number">21</span> utilities</a></li>
<li class="book-part">vcr details</li>
<li><a class="" href="vcr-intro.html"><span class="header-section-number">22</span> Caching HTTP requests</a></li>
<li><a class="active" href="vcr-usage.html"><span class="header-section-number">23</span> Advanced vcr usage</a></li>
<li><a class="" href="vcr-configuration.html"><span class="header-section-number">24</span> Configure vcr</a></li>
<li><a class="" href="record-modes.html"><span class="header-section-number">25</span> Record modes</a></li>
<li><a class="" href="request-matching.html"><span class="header-section-number">26</span> Request matching</a></li>
<li><a class="" href="debugging-your-tests-that-use-vcr.html"><span class="header-section-number">27</span> Debugging your tests that use vcr</a></li>
<li><a class="" href="vcr-security.html"><span class="header-section-number">28</span> Security with vcr</a></li>
<li><a class="" href="lightswitch.html"><span class="header-section-number">29</span> Turning vcr on and off</a></li>
<li><a class="" href="managing-cassettes.html"><span class="header-section-number">30</span> Managing cassettes</a></li>
<li><a class="" href="gotchas.html"><span class="header-section-number">31</span> Gotchas</a></li>
<li><a class="" href="session-info.html"><span class="header-section-number">32</span> Session info</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/ropensci-books/http-testing">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="vcr-usage" class="section level1" number="23">
<h1>
<span class="header-section-number">23</span> Advanced vcr usage<a class="anchor" aria-label="anchor" href="#vcr-usage"><i class="fas fa-link"></i></a>
</h1>
<p>Now that we’ve covered basic <code>vcr</code> usage, it’s time for some more advanced usage topics.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/vcr">"vcr"</a></span><span class="op">)</span></span></code></pre></div>
<div id="vcr-disk" class="section level2" number="23.1">
<h2>
<span class="header-section-number">23.1</span> Mocking writing to disk<a class="anchor" aria-label="anchor" href="#vcr-disk"><i class="fas fa-link"></i></a>
</h2>
<p>If you have http requests for which you write the response to disk, then
use <code><a href="https://docs.ropensci.org/vcr/reference/vcr_configure.html">vcr_configure()</a></code> to set the <code>write_disk_path</code> option. See more about
the <a href="#write-disk-path">write_disk_path configuration option</a>.</p>
<p>Here, we create a temporary directory, then set the fixtures</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmpdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/vcr/reference/vcr_configure.html">vcr_configure</a></span><span class="op">(</span></span>
<span>  dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"fixtures"</span><span class="op">)</span>,</span>
<span>  write_disk_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"files"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; &lt;vcr configuration&gt;
#&gt;   Cassette Dir: /tmp/RtmpynkcMz/fixtures
#&gt;   Record: once
#&gt;   Serialize with: yaml
#&gt;   URI Parser: crul::url_parse
#&gt;   Match Requests on: method, uri
#&gt;   Preserve Bytes?: FALSE
#&gt;   Logging?: FALSE
#&gt;   ignored hosts: 
#&gt;   ignore localhost?: FALSE
#&gt;   Write disk path: /tmp/RtmpynkcMz/files</code></pre>
<p>Then pass a file path (that doesn’t exist yet) to crul’s <code>disk</code> parameter.
<code>vcr</code> will take care of handling writing the response to that file in
addition to the cassette.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/crul/">crul</a></span><span class="op">)</span></span>
<span><span class="co">## make a temp file</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".json"</span><span class="op">)</span></span>
<span><span class="co">## make a request</span></span>
<span><span class="va">cas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/vcr/reference/use_cassette.html">use_cassette</a></span><span class="op">(</span><span class="st">"test_write_to_disk"</span>, <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="va"><a href="https://docs.ropensci.org/crul/reference/HttpClient.html">HttpClient</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"https://httpbin.org/get"</span><span class="op">)</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>disk <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">content</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span><span class="op">$</span><span class="fu">parse</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt; [1] "{\n  \"args\": {}, \n  \"headers\": {\n    \"Accept\": \"application/json, text/xml, application/xml, */*\", \n    \"Accept-Encoding\": \"gzip, deflate\", \n    \"Host\": \"httpbin.org\", \n    \"User-Agent\": \"libcurl/7.81.0 r-curl/5.2.0 crul/1.4.0\", \n    \"X-Amzn-Trace-Id\": \"Root=1-65b8c104-25a3f3a071840f6311fe3b90\"\n  }, \n  \"origin\": \"172.183.131.99\", \n  \"url\": \"https://httpbin.org/get\"\n}\n"</code></pre>
<p>This also works with <code>httr</code>. The only difference is that you write to disk
with a function <code>httr::write_disk(path)</code> rather than a parameter.</p>
<p>Note that when you write to disk when using <code>vcr</code>, the cassette is slightly
changed. Instead of holding the http response body itself, the cassette
has the file path with the response body.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb107-1"><a href="vcr-usage.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">http_interactions</span><span class="kw">:</span></span>
<span id="cb107-2"><a href="vcr-usage.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span></span>
<span id="cb107-3"><a href="vcr-usage.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">method</span><span class="kw">:</span><span class="at"> get</span></span>
<span id="cb107-4"><a href="vcr-usage.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">uri</span><span class="kw">:</span><span class="at"> https://httpbin.org/get</span></span>
<span id="cb107-5"><a href="vcr-usage.html#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">response</span><span class="kw">:</span></span>
<span id="cb107-6"><a href="vcr-usage.html#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">headers</span><span class="kw">:</span></span>
<span id="cb107-7"><a href="vcr-usage.html#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">status</span><span class="kw">:</span><span class="at"> HTTP/1.1 200 OK</span></span>
<span id="cb107-8"><a href="vcr-usage.html#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">access-control-allow-credentials</span><span class="kw">:</span><span class="at"> </span><span class="st">'true'</span></span>
<span id="cb107-9"><a href="vcr-usage.html#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">body</span><span class="kw">:</span></span>
<span id="cb107-10"><a href="vcr-usage.html#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">encoding</span><span class="kw">:</span><span class="at"> UTF-8</span></span>
<span id="cb107-11"><a href="vcr-usage.html#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">file</span><span class="kw">:</span><span class="at"> </span><span class="ch">yes</span></span>
<span id="cb107-12"><a href="vcr-usage.html#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">string</span><span class="kw">:</span><span class="at"> /private/var/folders/fc/n7g_vrvn0sx_st0p8lxb3ts40000gn/T/Rtmp5W4olr/files/file177e2e5d97ec.json</span></span></code></pre></div>
<p>And the file has the response body that otherwise would have been in the <code>string</code>
yaml field above:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb108-1"><a href="vcr-usage.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb108-2"><a href="vcr-usage.html#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"args"</span><span class="fu">:</span> <span class="fu">{},</span> </span>
<span id="cb108-3"><a href="vcr-usage.html#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"headers"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb108-4"><a href="vcr-usage.html#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"Accept"</span><span class="fu">:</span> <span class="st">"application/json, text/xml, application/xml, */*"</span><span class="fu">,</span> </span>
<span id="cb108-5"><a href="vcr-usage.html#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"Accept-Encoding"</span><span class="fu">:</span> <span class="st">"gzip, deflate"</span><span class="fu">,</span> </span>
<span id="cb108-6"><a href="vcr-usage.html#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"Host"</span><span class="fu">:</span> <span class="st">"httpbin.org"</span><span class="fu">,</span> </span>
<span id="cb108-7"><a href="vcr-usage.html#cb108-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"User-Agent"</span><span class="fu">:</span> <span class="st">"libcurl/7.54.0 r-curl/4.3 crul/0.9.0"</span></span>
<span id="cb108-8"><a href="vcr-usage.html#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span> </span>
<span id="cb108-9"><a href="vcr-usage.html#cb108-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"origin"</span><span class="fu">:</span> <span class="st">"24.21.229.59, 24.21.229.59"</span><span class="fu">,</span> </span>
<span id="cb108-10"><a href="vcr-usage.html#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"url"</span><span class="fu">:</span> <span class="st">"https://httpbin.org/get"</span></span>
<span id="cb108-11"><a href="vcr-usage.html#cb108-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="vcr-intro.html"><span class="header-section-number">22</span> Caching HTTP requests</a></div>
<div class="next"><a href="vcr-configuration.html"><span class="header-section-number">24</span> Configure vcr</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#vcr-usage"><span class="header-section-number">23</span> Advanced vcr usage</a></li>
<li><a class="nav-link" href="#vcr-disk"><span class="header-section-number">23.1</span> Mocking writing to disk</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/ropensci-books/http-testing/blob/main/08-vcr-usage.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/ropensci-books/http-testing/edit/main/08-vcr-usage.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>HTTP testing in R</strong>" was written by Scott Chamberlain, Maëlle Salmon. It was last built on 2024-01-30.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
